{% extends 'main/base.html' %}

{% block title %}–ú–æ–∏ –±–ª—é–¥–∞{% endblock %}

{% block content %}
<section class="card hero glow">
    <div class="grid cols-2">
        <div>
            <h1 class="title gradient-text">–ú–æ–∏ –±–ª—é–¥–∞</h1>
            <p class="lead">–í—Å–µ –≤–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –±–ª—é–¥–∞ —Å –∫–∞–ª–æ—Ä–∏—è–º–∏, –ë–ñ–£ –∏ —Å–ø–∏—Å–∫–æ–º –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
            <div class="inline-actions">
                <a class="btn btn-primary" href="{% url 'create_dish' %}">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</a>
                <a class="btn btn-ghost" href="{% url 'user_create_allergen' %}">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</a>
            </div>
        </div>
        <div class="card glow">
            <div class="stat">
                <span class="label">–í—Å–µ–≥–æ –±–ª—é–¥</span>
                <span class="value">{{ dishes.paginator.count|default:dishes|length }}</span>
            </div>
            <div class="stat">
                <span class="label">–ù–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ</span>
                <span class="value">
                    {% if dishes %}
                        {% if dishes.0.created_at %}
                            {{ dishes.0.created_at|date:"d.m.Y H:i" }}
                        {% else %}
                            {{ dishes.0.created_at|date:"d.m.Y H:i" }}
                        {% endif %}
                    {% else %}
                        ‚Äî
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</section>

<!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
<section class="card glow" style="margin-top: 16px;">
    <h2 class="title" style="margin-bottom: 12px;">–§–∏–ª—å—Ç—Ä—ã</h2>
    <form method="get" class="grid cols-4 gap-sm">
        <!-- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é -->
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" name="name" class="form-control" 
                   value="{{ current_name|default:'' }}" placeholder="–ü–æ–∏—Å–∫...">
        </div>
        
        <!-- –ö–∞–ª–æ—Ä–∏–∏ -->
        <div class="form-group">
            <label class="form-label">–ö–∞–ª–æ—Ä–∏–∏</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="calories_min" 
                       class="form-control" placeholder="–æ—Ç"
                       value="{{ current_calories_min|default:'' }}">
                <input type="number" step="0.1" name="calories_max" 
                       class="form-control" placeholder="–¥–æ"
                       value="{{ current_calories_max|default:'' }}">
            </div>
        </div>
        
        <!-- –ë–µ–ª–∫–∏ -->
        <div class="form-group">
            <label class="form-label">–ë–µ–ª–∫–∏ (–≥)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="protein_min" 
                       class="form-control" placeholder="–æ—Ç"
                       value="{{ current_protein_min|default:'' }}">
                <input type="number" step="0.1" name="protein_max" 
                       class="form-control" placeholder="–¥–æ"
                       value="{{ current_protein_max|default:'' }}">
            </div>
        </div>
        
        <!-- –ñ–∏—Ä—ã -->
        <div class="form-group">
            <label class="form-label">–ñ–∏—Ä—ã (–≥)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="fat_min" 
                       class="form-control" placeholder="–æ—Ç"
                       value="{{ current_fat_min|default:'' }}">
                <input type="number" step="0.1" name="fat_max" 
                       class="form-control" placeholder="–¥–æ"
                       value="{{ current_fat_max|default:'' }}">
            </div>
        </div>
        
        <!-- –£–≥–ª–µ–≤–æ–¥—ã -->
        <div class="form-group">
            <label class="form-label">–£–≥–ª–µ–≤–æ–¥—ã (–≥)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="carbs_min" 
                       class="form-control" placeholder="–æ—Ç"
                       value="{{ current_carbs_min|default:'' }}">
                <input type="number" step="0.1" name="carbs_max" 
                       class="form-control" placeholder="–¥–æ"
                       value="{{ current_carbs_max|default:'' }}">
            </div>
        </div>
        
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –º–æ–¥–µ–ª–∏) -->
        {% if categories %}
        <div class="form-group" style="grid-column: span 2;">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select name="category" class="form-control">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                {% for category in categories %}
                <option value="{{ category.id }}" 
                    {% if current_category == category.id|stringformat:"i" %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- –ò—Å–∫–ª—é—á–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã -->
        <div class="form-group" style="grid-column: span 4;">
            <label class="form-label">–ò—Å–∫–ª—é—á–∏—Ç—å –±–ª—é–¥–∞ —Å –∞–ª–ª–µ—Ä–≥–µ–Ω–∞–º–∏</label>
            <div class="chip-list" style="max-height: 200px; overflow: auto; display: flex; flex-wrap: wrap; gap: 8px;">
                {% for allergen in available_allergens %}
                    <label class="chip" style="cursor: pointer; display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px;">
                        <input type="checkbox"
                               name="exclude_allergens"
                               value="{{ allergen.id }}"
                               {% if allergen.id in current_exclude_allergens %}checked{% endif %}>
                        <span>{{ allergen.name }}</span>
                        {% if not allergen.is_global %}
                            <span class="badge">–º–æ–π</span>
                        {% else %}
                            <span class="badge">–≥–ª–æ–±–∞–ª—å–Ω—ã–π</span>
                        {% endif %}
                    </label>
                {% empty %}
                    <span class="muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤</span>
                {% endfor %}
            </div>
        </div>

        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º —Ñ–æ–Ω–æ–º -->
        <div class="form-group">
            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort_by" class="form-control" style="
                background-color: #7c3aed;
                color: white;
                border: 1px solid #8b5cf6;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
            ">
                <option value="-created_at" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-created_at" or not current_sort %}selected{% endif %}>
                    –ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞
                </option>
                <option value="created_at" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "created_at" %}selected{% endif %}>
                    –°—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞
                </option>
                <option value="name" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "name" %}selected{% endif %}>
                    –ù–∞–∑–≤–∞–Ω–∏–µ –ê-–Ø
                </option>
                <option value="-name" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-name" %}selected{% endif %}>
                    –ù–∞–∑–≤–∞–Ω–∏–µ –Ø-–ê
                </option>
                <option value="calories" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "calories" %}selected{% endif %}>
                    –ö–∞–ª–æ—Ä–∏–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                </option>
                <option value="-calories" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-calories" %}selected{% endif %}>
                    –ö–∞–ª–æ—Ä–∏–∏ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                </option>
                <option value="proteins" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "proteins" %}selected{% endif %}>
                    –ë–µ–ª–∫–∏ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                </option>
                <option value="-proteins" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-proteins" %}selected{% endif %}>
                    –ë–µ–ª–∫–∏ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                </option>
                <option value="fats" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "fats" %}selected{% endif %}>
                    –ñ–∏—Ä—ã (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                </option>
                <option value="-fats" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-fats" %}selected{% endif %}>
                    –ñ–∏—Ä—ã (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                </option>
                <option value="carbohydrates" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "carbohydrates" %}selected{% endif %}>
                    –£–≥–ª–µ–≤–æ–¥—ã (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                </option>
                <option value="-carbohydrates" 
                        style="background-color: #7c3aed; color: white;"
                        {% if current_sort == "-carbohydrates" %}selected{% endif %}>
                    –£–≥–ª–µ–≤–æ–¥—ã (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                </option>
            </select>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="form-group" style="display: flex; gap: 8px; align-items: flex-end;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            <a href="{% url 'dishes' %}" class="btn btn-ghost">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
    </form>
    
    <!-- CSS —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ -->
    <style>
        select[name="sort_by"] option {
            background-color: #7c3aed !important;
            color: white !important;
        }
        
        select[name="sort_by"]:hover {
            background-color: #6d28d9 !important;
        }
        
        select[name="sort_by"]:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }
    </style>
</section>

{% if dishes %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º -->
<section class="card glow" style="margin-top: 12px;">
    <div class="grid cols-4 gap-sm">
        <div class="stat">
            <span class="label">–°—Ä–µ–¥–Ω–∏–µ –∫–∞–ª–æ—Ä–∏–∏</span>
            <span class="value">
                {% if avg_calories %}
                    {{ avg_calories|floatformat:1 }} –∫–∫–∞–ª
                {% else %}
                    ‚Äî
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">–°—Ä–µ–¥–Ω–∏–µ –±–µ–ª–∫–∏</span>
            <span class="value">
                {% if avg_protein %}
                    {{ avg_protein|floatformat:1 }} –≥
                {% else %}
                    ‚Äî
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">–°—Ä–µ–¥–Ω–∏–µ –∂–∏—Ä—ã</span>
            <span class="value">
                {% if avg_fat %}
                    {{ avg_fat|floatformat:1 }} –≥
                {% else %}
                    ‚Äî
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">–°—Ä–µ–¥–Ω–∏–µ —É–≥–ª–µ–≤–æ–¥—ã</span>
            <span class="value">
                {% if avg_carbs %}
                    {{ avg_carbs|floatformat:1 }} –≥
                {% else %}
                    ‚Äî
                {% endif %}
            </span>
        </div>
    </div>
</section>

<!-- –°–ø–∏—Å–æ–∫ –±–ª—é–¥ -->
<section class="grid cols-2" style="margin-top: 20px;">
    {% for dish in dishes %}
    <article class="card glow">
        <div class="inline-actions" style="justify-content: space-between; align-items: flex-start;">
            <div>
                <p class="pill">–î–æ–±–∞–≤–ª–µ–Ω–æ {{ dish.created_at|date:"d.m.Y" }}</p>
                <h2 class="title" style="margin: 8px 0 4px;">{{ dish.name }}</h2>
                {% if dish.description %}
                    <p class="muted" style="margin: 0 0 10px;">{{ dish.description }}</p>
                {% endif %}
            </div>
            <div class="btn-group" style="display: flex; gap: 8px;">
                {% if dish.url %}
                    <a class="btn btn-ghost" href="{{ dish.url }}" target="_blank" rel="noopener">–†–µ—Ü–µ–ø—Ç</a>
                {% endif %}
                {% if dish.photo %}
                    <button type="button" 
                            class="btn btn-ghost view-photo-btn" 
                            data-photo-url="{% if dish.photo %}{{ dish.photo.url }}{% else %}#{% endif %}"
                            data-dish-name="{{ dish.name }}">
                        üëÅÔ∏è –§–æ—Ç–æ
                    </button>
                {% endif %}
                <a class="btn btn-primary" href="{% url 'dish_edit' dish.pk %}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                <form method="post" action="{% url 'dish_delete' dish.pk %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ?');">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <div class="grid cols-2" style="margin-top: 8px;">
            <div class="stat">
                <span class="label">–ö–∞–ª–æ—Ä–∏–∏</span>
                <span class="value">{{ dish.calories|default:"‚Äî" }}</span>
            </div>
            <div class="stat">
                <span class="label">–ë–µ–ª–∫–∏ ¬∑ –ñ–∏—Ä—ã ¬∑ –£–≥–ª–µ–≤–æ–¥—ã</span>
                <span class="value">
                    {{ dish.proteins|default:"‚Äî" }} ¬∑ {{ dish.fats|default:"‚Äî" }} ¬∑ {{ dish.carbohydrates|default:"‚Äî" }}
                </span>
            </div>
        </div>

        <div style="margin-top: 12px;">
            <p class="section-title" style="margin: 0 0 6px;">–ê–ª–ª–µ—Ä–≥–µ–Ω—ã</p>
            {% if dish.allergens.all %}
                <ul class="chip-list">
                    {% for allergen in dish.allergens.all %}
                        <li>{{ allergen.name }}</li>
                    {% empty %}
                        <li class="muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="muted">–ù–µ —É–∫–∞–∑–∞–Ω—ã</p>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</section>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if dishes.paginator.num_pages > 1 %}
<section class="card glow" style="margin-top: 16px; text-align: center;">
    <div class="pagination">
        {% if dishes.has_previous %}
            <a href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">–ü–µ—Ä–≤–∞—è</a>
            <a href="?page={{ dishes.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">‚Üê</a>
        {% endif %}
        
        <span class="pagination-info">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ dishes.number }} –∏–∑ {{ dishes.paginator.num_pages }}
        </span>
        
        {% if dishes.has_next %}
            <a href="?page={{ dishes.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">‚Üí</a>
            <a href="?page={{ dishes.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
        {% endif %}
    </div>
</section>
{% endif %}

{% else %}
<!-- –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç –±–ª—é–¥ -->
<section class="card glow" style="margin-top: 16px; text-align: center;">
    <h2 class="title" style="margin-bottom: 6px;">–ü–æ–∫–∞ –Ω–µ—Ç –±–ª—é–¥</h2>
    <p class="muted">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—ë –ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–∞–ª–æ—Ä–∏–∏ –∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã.</p>
    <div style="margin-top: 12px;">
        <a class="btn btn-primary" href="{% url 'create_dish' %}">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</a>
    </div>
</section>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
<div id="photo-modal" class="modal" style="
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    align-items: center;
    justify-content: center;
">
    <div class="modal-content" style="
        max-width: 90%;
        max-height: 90%;
        background: transparent;
        position: relative;
    ">
        <span class="close-btn" style="
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        ">&times;</span>
        
        <img id="modal-photo" src="" alt="–§–æ—Ç–æ –±–ª—é–¥–∞" style="
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        ">
        
        <div id="photo-caption" style="
            color: white;
            text-align: center;
            margin-top: 16px;
            font-size: 1.1rem;
            font-weight: 500;
        "></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('photo-modal');
    const modalPhoto = document.getElementById('modal-photo');
    const photoCaption = document.getElementById('photo-caption');
    const closeBtn = document.querySelector('.close-btn');
    const viewPhotoBtns = document.querySelectorAll('.view-photo-btn');
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–§–æ—Ç–æ"
    viewPhotoBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const photoUrl = this.getAttribute('data-photo-url');
            const dishName = this.getAttribute('data-dish-name');
            
            modalPhoto.src = photoUrl;
            photoCaption.textContent = dishName;
            modal.style.display = 'flex';
        });
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
        }
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–∞–º–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    modalPhoto.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});
</script>

<style>
.modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.view-photo-btn {
    display: flex;
    align-items: center;
    gap: 4px;
}

.close-btn:hover {
    background: rgba(0, 0, 0, 0.7) !important;
}
</style>
{% endblock %}
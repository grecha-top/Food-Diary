{% extends 'main/base.html' %}

{% block title %}Мои блюда{% endblock %}

{% block content %}
<section class="card hero glow">
    <div class="grid cols-2">
        <div>
            <h1 class="title gradient-text">Мои блюда</h1>
            <p class="lead">Все ваши сохранённые блюда с калориями, БЖУ и списком аллергенов в одном месте.</p>
            <div class="inline-actions">
                <a class="btn btn-primary" href="{% url 'create_dish' %}">Добавить блюдо</a>
                <a class="btn btn-ghost" href="{% url 'user_create_allergen' %}">Настроить аллергены</a>
            </div>
        </div>
        <div class="card glow">
            <div class="stat">
                <span class="label">Всего блюд</span>
                <span class="value">{{ dishes.paginator.count|default:dishes|length }}</span>
            </div>
            <div class="stat">
                <span class="label">Недавно добавлено</span>
                <span class="value">
                    {% if dishes %}
                        {% if dishes.0.created_at %}
                            {{ dishes.0.created_at|date:"d.m.Y H:i" }}
                        {% else %}
                            {{ dishes.0.created_at|date:"d.m.Y H:i" }}
                        {% endif %}
                    {% else %}
                        —
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</section>

<!-- Форма фильтров -->
<section class="card glow" style="margin-top: 16px;">
    <h2 class="title" style="margin-bottom: 12px;">Фильтры</h2>
    <form method="get" class="grid cols-4 gap-sm">
        <!-- Поиск по названию -->
        <div class="form-group">
            <label class="form-label">Название</label>
            <input type="text" name="name" class="form-control" 
                   value="{{ current_name|default:'' }}" placeholder="Поиск...">
        </div>
        
        <!-- Калории -->
        <div class="form-group">
            <label class="form-label">Калории</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="calories_min" 
                       class="form-control" placeholder="от"
                       value="{{ current_calories_min|default:'' }}">
                <input type="number" step="0.1" name="calories_max" 
                       class="form-control" placeholder="до"
                       value="{{ current_calories_max|default:'' }}">
            </div>
        </div>
        
        <!-- Белки -->
        <div class="form-group">
            <label class="form-label">Белки (г)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="protein_min" 
                       class="form-control" placeholder="от"
                       value="{{ current_protein_min|default:'' }}">
                <input type="number" step="0.1" name="protein_max" 
                       class="form-control" placeholder="до"
                       value="{{ current_protein_max|default:'' }}">
            </div>
        </div>
        
        <!-- Жиры -->
        <div class="form-group">
            <label class="form-label">Жиры (г)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="fat_min" 
                       class="form-control" placeholder="от"
                       value="{{ current_fat_min|default:'' }}">
                <input type="number" step="0.1" name="fat_max" 
                       class="form-control" placeholder="до"
                       value="{{ current_fat_max|default:'' }}">
            </div>
        </div>
        
        <!-- Углеводы -->
        <div class="form-group">
            <label class="form-label">Углеводы (г)</label>
            <div class="grid cols-2 gap-xs">
                <input type="number" step="0.1" name="carbs_min" 
                       class="form-control" placeholder="от"
                       value="{{ current_carbs_min|default:'' }}">
                <input type="number" step="0.1" name="carbs_max" 
                       class="form-control" placeholder="до"
                       value="{{ current_carbs_max|default:'' }}">
            </div>
        </div>
        
        <!-- Категория (если есть в модели) -->
        {% if categories %}
        <div class="form-group">
            <label class="form-label">Категория</label>
            <select name="category" class="form-control">
                <option value="">Все категории</option>
                {% for category in categories %}
                <option value="{{ category.id }}" 
                    {% if current_category == category.id|stringformat:"i" %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        
        <!-- Сортировка -->
        <div class="form-group">
            <label class="form-label">Сортировка</label>
            <select name="sort_by" class="form-control">
                <option value="-created_at" {% if current_sort == "-created_at" or not current_sort %}selected{% endif %}>
                    Новые сначала
                </option>
                <option value="created_at" {% if current_sort == "created_at" %}selected{% endif %}>
                    Старые сначала
                </option>
                <option value="name" {% if current_sort == "name" %}selected{% endif %}>
                    Название А-Я
                </option>
                <option value="-name" {% if current_sort == "-name" %}selected{% endif %}>
                    Название Я-А
                </option>
                <option value="calories" {% if current_sort == "calories" %}selected{% endif %}>
                    Калории (по возрастанию)
                </option>
                <option value="-calories" {% if current_sort == "-calories" %}selected{% endif %}>
                    Калории (по убыванию)
                </option>
                <option value="protein" {% if current_sort == "protein" %}selected{% endif %}>
                    Белки (по возрастанию)
                </option>
                <option value="-protein" {% if current_sort == "-protein" %}selected{% endif %}>
                    Белки (по убыванию)
                </option>
                <option value="fat" {% if current_sort == "fat" %}selected{% endif %}>
                    Жиры (по возрастанию)
                </option>
                <option value="-fat" {% if current_sort == "-fat" %}selected{% endif %}>
                    Жиры (по убыванию)
                </option>
                <option value="carbohydrates" {% if current_sort == "carbohydrates" %}selected{% endif %}>
                    Углеводы (по возрастанию)
                </option>
                <option value="-carbohydrates" {% if current_sort == "-carbohydrates" %}selected{% endif %}>
                    Углеводы (по убыванию)
                </option>
            </select>
        </div>
        
        <!-- Кнопки -->
        <div class="form-group" style="display: flex; gap: 8px; align-items: flex-end;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">Применить фильтры</button>
            <a href="{% url 'dishes' %}" class="btn btn-ghost">Сбросить</a>
        </div>
    </form>
</section>

{% if dishes %}
<!-- Статистика по фильтрам -->
<section class="card glow" style="margin-top: 12px;">
    <div class="grid cols-4 gap-sm">
        <div class="stat">
            <span class="label">Средние калории</span>
            <span class="value">
                {% if avg_calories %}
                    {{ avg_calories|floatformat:1 }} ккал
                {% else %}
                    —
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">Средние белки</span>
            <span class="value">
                {% if avg_protein %}
                    {{ avg_protein|floatformat:1 }} г
                {% else %}
                    —
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">Средние жиры</span>
            <span class="value">
                {% if avg_fat %}
                    {{ avg_fat|floatformat:1 }} г
                {% else %}
                    —
                {% endif %}
            </span>
        </div>
        <div class="stat">
            <span class="label">Средние углеводы</span>
            <span class="value">
                {% if avg_carbs %}
                    {{ avg_carbs|floatformat:1 }} г
                {% else %}
                    —
                {% endif %}
            </span>
        </div>
    </div>
</section>

<!-- Список блюд -->
<section class="grid cols-2" style="margin-top: 20px;">
    {% for dish in dishes %}
    <article class="card glow">
        <div class="inline-actions" style="justify-content: space-between; align-items: flex-start;">
            <div>
                <p class="pill">Добавлено {{ dish.created_at|date:"d.m.Y" }}</p>
                <h2 class="title" style="margin: 8px 0 4px;">{{ dish.name }}</h2>
                {% if dish.description %}
                    <p class="muted" style="margin: 0 0 10px;">{{ dish.description }}</p>
                {% endif %}
            </div>
            {% if dish.url %}
                <a class="btn btn-ghost" href="{{ dish.url }}" target="_blank" rel="noopener">Рецепт</a>
            {% endif %}
        </div>

        <div class="grid cols-2" style="margin-top: 8px;">
            <div class="stat">
                <span class="label">Калории</span>
                <span class="value">{{ dish.calories|default:"—" }}</span>
            </div>
            <div class="stat">
                <span class="label">Белки · Жиры · Углеводы</span>
                <span class="value">
                    {{ dish.protein|default:"—" }} · {{ dish.fat|default:"—" }} · {{ dish.carbohydrates|default:"—" }}
                </span>
            </div>
        </div>

        <div style="margin-top: 12px;">
            <p class="section-title" style="margin: 0 0 6px;">Аллергены</p>
            {% if dish.allergens.all %}
                <ul class="chip-list">
                    {% for allergen in dish.allergens.all %}
                        <li>{{ allergen.name }}</li>
                    {% empty %}
                        <li class="muted">Не указаны</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="muted">Не указаны</p>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</section>

<!-- Пагинация -->
{% if dishes.paginator.num_pages > 1 %}
<section class="card glow" style="margin-top: 16px; text-align: center;">
    <div class="pagination">
        {% if dishes.has_previous %}
            <a href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">Первая</a>
            <a href="?page={{ dishes.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">←</a>
        {% endif %}
        
        <span class="pagination-info">
            Страница {{ dishes.number }} из {{ dishes.paginator.num_pages }}
        </span>
        
        {% if dishes.has_next %}
            <a href="?page={{ dishes.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">→</a>
            <a href="?page={{ dishes.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="btn btn-ghost">Последняя</a>
        {% endif %}
    </div>
</section>
{% endif %}

{% else %}
<!-- Сообщение, если нет блюд -->
<section class="card glow" style="margin-top: 16px; text-align: center;">
    <h2 class="title" style="margin-bottom: 6px;">Пока нет блюд</h2>
    <p class="muted">Добавьте своё первое блюдо и отслеживайте калории и аллергены.</p>
    <div style="margin-top: 12px;">
        <a class="btn btn-primary" href="{% url 'create_dish' %}">Добавить блюдо</a>
    </div>
</section>
{% endif %}
{% endblock %}